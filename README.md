# Master-Thesis-MBC
Final Master's Thesis of the Master in Computational Biology (UPM)

# Procedures 
1. Environmental data retrieval 

The environmental data retrieval of populations belonging to 1000 Genomes and Simons Genome Diversity Project (SGDP) genomics databases was carried out prior to the realization of this Master’s Thesis and remains outside the limits that it covers. However, it is necessary to give a brief explanation of how this process was accomplished, which will help to understand the rest of the procedures. 
Environmental data for three environmental variables were downloaded: 1) radiation (rad) from Worldclim; 2) temperature and humidity (th) from ecoClimate and 3) elevation (ele) from ETOPO1 Global Relief Model. To reduce the number of correlated variables in rad and th, a Principal Component Analysis (PCA) was carried out. In the case of ele, original variables were used. With data of each of the three environmental variables, three environmental raster images were built showing environmental gradients across the whole world. A raster image is a two-dimensional grid of square pixels. In this case, each pixel was assigned an environmental value. The interest in using raster for data representation lies in its greater efficiency to manage environmental data.

2. Selection of human populations and genomic samples 

Genomic human samples were selected according to the population of origin to which they belonged. The first step was to search for those populations, based on four criteria: 
	
  - Environmental divergence among populations
  
This criterion aims to maximize the environmental variance and minimize the geographic distance between the populations (Rellstab et al., 2015). With this, it is possible to correct the effect of isolation by distance (IBD) between them, so that if genome variations are found among them, they will be due to adaptive processes with greater probability.  To achieve that, the environmental divergence index was calculated for every pair of populations and every environmental variable as follows:
Environmental divergence index = (Environmental distance between populations)/(Geographic distance between populations)
Then, a ranking with the maximum punctuations of the environmental divergence index of pairs of populations was established, one for each environmental variable. 

  - Population size
  
From those rankings, only pairs of populations with a minimum number of genotyped individuals were selected. This criterion is based on the results thrown by Graph-aware Retrieval of Selective Sweeps (GRoSS) (Refoyo-Martínez et al., 2019), the tool that is used in this study to find loci under selection. For low sample sizes (N = 4), the authors found high rates of type I and II errors, whereas it does not happen for greater sample sizes. In order to ensure the minimization of errors, the threshold was established at N = 12. For that reason, any pair of populations that did not meet this criterion was excluded.

   - Availability of their genomic data in genomic databases of interest
  
At first, the genomic data was intended to be extracted from different independent databases, to later unify them. The genomic databases from which it is easier to extract genomic data in VCF format are 1000 Genomes and Human Genome Diversity Project (HGDP). HGDP is a genomic database similar to SGDP, with the addition that it contains a greater number of samples by population. For that reason, only those pairs of populations whose individual’s genomic data were included in the 1000 Genomes and HGDP were selected (rankings3). However, a recent article (Wohns et al., 2022) was published while this study was being developed. In it, genomic data from 1000 Genomes, HGDP and SGDP are unified in the same database. This fact facilitated the process of genomic data extraction (see the section ‘Genomic data retrieval’). Due to the change in the methodological strategy, the application of this criterion was no longer necessary. Even so, it was maintained, since the selection of the populations was carried out prior to the publication of the aforementioned article.

   - One pair of populations by great continent 
  
Continents are the geographic accidents that contribute the most to the genetic structure. In order to have a representative sample of humankind, only four pairs of populations (each belonging to a great continent: Africa, Europe, Asia and America) were selected for each environmental variable. The exception was rad, for which five pairs were selected. It was considered interesting to include two populations from different continents. 

After applying all these four criteria, 18 populations were included in the study. From each population, 20 individuals were randomly selected, provided that the population size allowed it. A total of 330 samples were selected, although not all of them were finally included in the analysis (see the section ‘Genomic data retrieval’).

3. Genomic data retrieval

Raw genomic data was retrieved from a recently published unified dataset (Wohns et al., 2022). This genomic data is available in the open access repository Zenodo in the form of unified and inferred tree sequences from the 1000 Genomes, HGDP and SGDP databases. From the whole genome, only genomic data from the p arm of chromosome 12 was selected arbitrarily to perform the analysis. The correspondent file was downloaded, which contained a total of 3754 samples. It was not uploaded because of its huge size. Then, metadata was retrieved from this file through a Python 3 (Rossum & Drake, 2009) script in order to obtain the two identifiers of each of the 3754 samples: the identifier corresponding to the 1000 Genomes and HGDP databases and the identifier belonging to the Wohns et al., 2022 database. These data were merged with the data of the 330 samples previously selected, by the identifier of 1000 Genomes and HGDP using an R 4.2.0 (R Core Team, 2022) script in RStudio 2022.02.2 (RStudio Team, 2022). A total of 43 of the 330 samples of interest were excluded for not being included in the downloaded tree file. For that reason, the final number of samples included for the study was 287. Then, the downloaded tree file was converted to VCF format through a script based on Python 3 (Rossum & Drake, 2009) and filtered by samples of interest using VCFtools 4.2. (Danecek et al., 2011). In the end, the final file containing genomic data to carry out the analysis consisted in a VCF file format, which included 1,149,453 Single Nucleotide Polymorphisms (SNPs) and 287 individuals.

4. Finding the phylogeny among samples 

Before carrying out the outlier test to find SNPs under selection, it was necessary to establish the evolutionary relationships among samples (i.e. phylogenetic tree). This process was achieved in two different ways: 

   - Using the software TreeMix1.13 (Pickrell& Pritchard, 2012). TreeMix is a program for the inference of patterns of population splitting from genome-wide allele frequency data. If given a set of allele frequencies from a number of populations, it will return the maximum likelihood tree for the set of populations. A good practice to build a phylogenetic tree is to use only independent SNPs. For that reason, the VCF file was previously pruned by SNPs that provided null or redundant information: 1) invariant sites (IS), using BCFtools 1.7 (Danecek et al., 2021). SNPs whose allele frequencies do not vary between populations were removed, since they do not provide any information of interest; 2) linkage disequilibrium (LD), making use of PLINK 1.9 (Purcell et al., 2007). Those SNPs that segregate together during meiosis process were removed, since their allele frequencies vary at the same time and they cannot be considered as independent. These two filters were applied by executing the same script. After that, the allele frequencies in each population were obtained through a script using PLINK 2.0 (Purcell et al., 2007). Data of allele frequencies from different populations were joined in the same database. Subsequently, a new filter was applied to this genomic database: minor allele frequency (MAF) < 0.05, using an R 4.2.0 (R Core Team, 2022) script in RStudio 2022.02.2 (RStudio Team, 2022). Those alleles that had a frequency lower than 0.05 (or greater than 0.95) in any of the populations were removed. If this were not done, the conservation of SNPs with rare alleles would increase the false discovery rate in the outlier test. The application of all these three filters was necessary before running TreeMix because this software does not do it by itself. After that, 10,045 SNPs remained in the final database. Then, the alternative and reference allele counts by population were calculated from the allele frequencies values in order to generate the input of TreeMix. After the execution of the TreeMix script, the output was generated, and the tree was visualized using an R 4.2.0 (R Core Team, 2022) script in RStudio 2022.02.2 (RStudio Team, 2022). However, TreeMix generates unrooted trees. The tree was rooted and visualized using the Python based environment ETEToolkit (Huerta-Cepas et al., 2016).

   - In collaboration with an expert in human phylogeny. 

Because two different phylogenies were obtained, from here, two analyses were carried out in parallel (Analysis 1 and Analysis 2). This allowed evaluating the consistency of the outlier test based on the phylogeny architecture.

